# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä»•æ§˜æ›¸ï¼ˆå®Œå…¨èªè¨¼ã‚·ã‚¹ãƒ†ãƒ çµ±åˆç‰ˆï¼‰

## æ¦‚è¦

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯MySQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã€**Magic Link + JWT + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰**ã®ä½µç”¨èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
æ—¢å­˜ã®ã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ã¨ã®å®Œå…¨ãªäº’æ›æ€§ã‚’ä¿ã¡ãªãŒã‚‰ã€æœ€æ–°ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã‚’æº€ãŸã™èªè¨¼åŸºç›¤ã‚’æä¾›ã—ã¾ã™ã€‚

### ä¸»è¦ãªç‰¹å¾´
- **Magic Linkèªè¨¼**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹èªè¨¼ã‚’ãƒ¡ã‚¤ãƒ³æ–¹å¼ã¨ã—ã¦æ¡ç”¨
- **JWTèªè¨¼**: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ15åˆ†ï¼‰+ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ30æ—¥ï¼‰ã®çµ„ã¿åˆã‚ã›
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼**: éå¸¸å£ã¨ã—ã¦ä»»æ„ã§è¨­å®šå¯èƒ½
- **Redisé€£æº**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ**: ç«¯æœ«ã”ã¨ã®ç´°ã‹ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: 2FAã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–

---

## ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

### ğŸ” èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | é‡è¦åº¦ |
|-----------|------|--------|
| `users` | ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ± | â­â­â­ |
| `user_profiles` | ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« | â­â­ |
| `auth_credentials` | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼æƒ…å ± | â­â­ |
| `user_devices` | ç«¯æœ«ç®¡ç† | â­â­ |
| `magic_link_tokens` | Magic Linkèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ | â­â­â­ |
| `sessions` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | â­â­â­ |
| `refresh_tokens` | ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç† | â­â­â­ |
| `jwt_blacklist` | JWTå³æ™‚å¤±åŠ¹ç®¡ç† | â­â­ |
| `two_factor_auth` | 2è¦ç´ èªè¨¼è¨­å®š | â­â­ |
| `oauth_accounts` | OAuthé€£æºï¼ˆå°†æ¥ç”¨ï¼‰ | â­ |

### ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ç›£æŸ»
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | é‡è¦åº¦ |
|-----------|------|--------|
| `login_attempts` | ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œè¨˜éŒ² | â­â­â­ |
| `security_events` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ² | â­â­â­ |
| `admin_logs` | ç®¡ç†è€…æ“ä½œãƒ­ã‚° | â­â­ |

### ğŸ® ã‚²ãƒ¼ãƒ æ©Ÿèƒ½
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | é‡è¦åº¦ |
|-----------|------|--------|
| `battle_results` | ãƒãƒˆãƒ«çµæœè¨˜éŒ² | â­â­â­ |
| `battle_rounds` | ãƒãƒˆãƒ«ãƒ©ã‚¦ãƒ³ãƒ‰è©³ç´° | â­â­ |
| `user_stats` | ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ | â­â­â­ |
| `daily_rankings` | æ—¥æ¬¡ãƒ©ãƒ³ã‚­ãƒ³ã‚° | â­â­ |
| `weekly_rankings` | é€±æ¬¡ãƒ©ãƒ³ã‚­ãƒ³ã‚° | â­â­ |

### âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†
| ãƒ†ãƒ¼ãƒ–ãƒ«å | ç”¨é€” | é‡è¦åº¦ |
|-----------|------|--------|
| `system_settings` | ã‚·ã‚¹ãƒ†ãƒ è¨­å®š | â­â­ |
| `activity_logs` | ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚° | â­â­ |
| `system_stats` | ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ | â­ |

---

## èªè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°

### 1. usersï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±ï¼‰â­â­â­

**ç”¨é€”**: èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸ã¨ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±ç®¡ç†

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ç®¡ç†ã‚³ãƒ¼ãƒ‰ | management_code | BIGINT AUTO_INCREMENT | NO | | æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ äº’æ›ç”¨ã€å†…éƒ¨ç®¡ç†ãƒ»é€£æº |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | NO (PK) | | JWTã®subã‚¯ãƒ¬ãƒ¼ãƒ ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€å¤–éƒ¨ã‚­ãƒ¼å‚ç…§ç”¨ |
| ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | email | VARCHAR(255) | NO (UNIQUE) | | Magic Linké€ä¿¡å…ˆã€ãƒ­ã‚°ã‚¤ãƒ³è­˜åˆ¥å­ã€é‡è¤‡é˜²æ­¢ |
| ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  | nickname | VARCHAR(100) | NO | | ã‚²ãƒ¼ãƒ å†…è¡¨ç¤ºåã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º |
| æ¨©é™ãƒ¬ãƒ™ãƒ« | role | ENUM | NO | 'user' | ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€æ©Ÿèƒ½åˆ¶é™ï¼ˆuser/developer/adminï¼‰ |
| ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ | is_active | BOOLEAN | NO | TRUE | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæœ‰åŠ¹æ€§ã€BANãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† |
| ä½œæˆæ—¥æ™‚ | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ—¥æ™‚ã€çµ±è¨ˆãƒ»ç›£æŸ»ç”¨ |
| æ›´æ–°æ—¥æ™‚ | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | æœ€çµ‚æ›´æ–°æ—¥æ™‚ã€ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç›£è¦– |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **PRIMARY KEY**: user_id
- **UNIQUE KEY**: management_code, email
- **INDEX**: role, is_active, created_at

#### ç‰¹è¨˜äº‹é …
- Magic Linkèªè¨¼ã§ã¯`email`ãŒä¸»è¦ãªè­˜åˆ¥å­
- `management_code`ã¯æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®äº’æ›æ€§ç¶­æŒç”¨
- `user_id`ã¯JWTãƒˆãƒ¼ã‚¯ãƒ³ã®`sub`ã‚¯ãƒ¬ãƒ¼ãƒ ã¨ã—ã¦ä½¿ç”¨

---

### 2. user_profilesï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰â­â­

**ç”¨é€”**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°æƒ…å ±ç®¡ç†ï¼ˆå€‹äººæƒ…å ±å«ã‚€ï¼‰

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | NO (PK) | | users.user_idã¨ã®ç´ä»˜ã‘ |
| å®Ÿå | full_name | VARCHAR(100) | YES | | æœ¬äººç¢ºèªã€å…¬çš„æ‰‹ç¶šãç”¨ |
| é›»è©±ç•ªå· | phone_number | VARCHAR(15) | YES | | é€£çµ¡å…ˆã€ç·Šæ€¥æ™‚é€£çµ¡ç”¨ |
| éƒµä¾¿ç•ªå· | postal_code | VARCHAR(10) | YES | | ä½æ‰€æƒ…å ±ã€é…é€ãƒ»çµ±è¨ˆç”¨ |
| ä½æ‰€ | address | VARCHAR(255) | YES | | ä½æ‰€æƒ…å ±ã€é…é€ãƒ»çµ±è¨ˆç”¨ |
| ç”Ÿå¹´æœˆæ—¥ | birthdate | DATE | YES | | å¹´é½¢åˆ¶é™ã€çµ±è¨ˆåˆ†æç”¨ |
| å­¦æ ¡å | university | VARCHAR(100) | YES | | å­¦ç”Ÿèªè¨¼ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ©Ÿèƒ½ç”¨ |
| ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ | profile_image_url | VARCHAR(500) | YES | | ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤ºã€å€‹æ€§åŒ– |
| å­¦ç”Ÿè¨¼ç”»åƒ | student_id_image_url | VARCHAR(500) | YES | | å­¦ç”Ÿèªè¨¼ã€æœ¬äººç¢ºèªç”¨ |
| å­¦ç”Ÿè¨¼ç·¨é›†å¯å¦ | is_student_id_editable | BOOLEAN | NO | FALSE | ç·¨é›†åˆ¶å¾¡ã€ä¸æ­£é˜²æ­¢ |
| ã‚¿ã‚¤ãƒˆãƒ« | title | VARCHAR(100) | YES | | ã‚²ãƒ¼ãƒ å†…ç§°å·ã€é”æˆæ„Ÿæ¼”å‡º |
| åˆ¥å | alias | VARCHAR(100) | YES | | ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ è£œå®Œã€å€‹æ€§åŒ– |

#### å¤–éƒ¨ã‚­ãƒ¼
- **user_id** â†’ users(user_id) ON DELETE CASCADE

---

### 3. auth_credentialsï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼æƒ…å ±ï¼‰â­â­

**ç”¨é€”**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã®è³‡æ ¼æƒ…å ±ç®¡ç†ï¼ˆä»»æ„è¨­å®šï¼‰

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | NO (PK) | | users.user_idã¨ã®ç´ä»˜ã‘ |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ | password_hash | VARCHAR(255) | YES | | Argon2idãƒãƒƒã‚·ãƒ¥å€¤ã€èªè¨¼æ™‚æ¤œè¨¼ç”¨ |
| ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  | password_algo | ENUM | NO | 'argon2id' | å°†æ¥ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ç§»è¡Œå¯¾å¿œ |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | password_version | SMALLINT | NO | 1 | ãƒãƒƒã‚·ãƒ¥å¼·åº¦å¤‰æ›´å±¥æ­´ç®¡ç† |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°æ—¥æ™‚ | password_updated_at | TIMESTAMP | YES | | æœ€çµ‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ—¥æ™‚ã€å¼·åˆ¶å¤‰æ›´åˆ¤å®š |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœ‰åŠ¹åŒ– | is_password_enabled | BOOLEAN | NO | FALSE | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã®æœ‰åŠ¹ç„¡åŠ¹åˆ¶å¾¡ |

#### å¤–éƒ¨ã‚­ãƒ¼
- **user_id** â†’ users(user_id) ON DELETE CASCADE

#### ç‰¹è¨˜äº‹é …
- Magic Linkä¸»ä½“ã§ã‚‚ã€Œéå¸¸å£ã€ã¨ã—ã¦æœ‰åŠ¹åŒ–å¯èƒ½
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æœªè¨­å®šã§ã‚‚`is_password_enabled=FALSE`ã§é‹ç”¨å¯èƒ½

---

### 4. user_devicesï¼ˆç«¯æœ«ç®¡ç†ï¼‰â­â­

**ç”¨é€”**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆ©ç”¨ç«¯æœ«æƒ…å ±ç®¡ç†ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ¶å¾¡

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ãƒ‡ãƒã‚¤ã‚¹ID | device_id | VARCHAR(100) | NO (PK) | | ç«¯æœ«ä¸€æ„è­˜åˆ¥å­ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ç”¨ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | NO | | users.user_idã¨ã®ç´ä»˜ã‘ |
| ãƒ‡ãƒã‚¤ã‚¹å | device_name | VARCHAR(100) | YES | | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ç«¯æœ«åã€ç®¡ç†ç”»é¢è¡¨ç¤ºç”¨ |
| ãƒ‡ãƒã‚¤ã‚¹ç¨®åˆ¥ | device_type | ENUM | NO | 'unknown' | ç«¯æœ«ç¨®åˆ¥è­˜åˆ¥ã€UIæœ€é©åŒ–ç”¨ |
| OSæƒ…å ± | os_info | VARCHAR(100) | YES | | OSè©³ç´°æƒ…å ±ã€äº’æ›æ€§ç¢ºèªç”¨ |
| ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ± | browser_info | VARCHAR(100) | YES | | ãƒ–ãƒ©ã‚¦ã‚¶è©³ç´°ã€æ©Ÿèƒ½å¯¾å¿œç¢ºèªç”¨ |
| ä¿¡é ¼æ¸ˆã¿ | is_trusted | BOOLEAN | NO | FALSE | ä¿¡é ¼æ¸ˆã¿ç«¯æœ«ã€2FAçœç•¥åˆ¤å®šç”¨ |
| ã‚¢ã‚¯ãƒ†ã‚£ãƒ– | is_active | BOOLEAN | NO | TRUE | ç«¯æœ«æœ‰åŠ¹æ€§ã€åˆ©ç”¨åˆ¶å¾¡ç”¨ |
| æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹ | last_accessed_at | TIMESTAMP | YES | | æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚ã€éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç«¯æœ«æ¤œçŸ¥ |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **INDEX**: user_id, device_type, is_active, last_accessed_at

---

### 5. magic_link_tokensï¼ˆMagic Linkèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰â­â­â­

**ç”¨é€”**: Magic Linkèªè¨¼ã®ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥ | token_hash | VARCHAR(128) | NO (PK) | | SHA-256ãƒãƒƒã‚·ãƒ¥å€¤ã€æ”¹ã–ã‚“é˜²æ­¢ãƒ»æ¤œç´¢ç”¨ |
| ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | email | VARCHAR(255) | NO | | é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ç”¨ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | YES | | æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã®ç´ä»˜ã‘ |
| ç™ºè¡Œæ—¥æ™‚ | issued_at | DATETIME | NO | | ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆæ—¥æ™‚ã€ç›£æŸ»ãƒ»çµ±è¨ˆç”¨ |
| æœ‰åŠ¹æœŸé™ | expires_at | DATETIME | NO | | 15åˆ†å¾Œè¨­å®šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºä¿ |
| ä½¿ç”¨æ—¥æ™‚ | used_at | DATETIME | YES | | ä½¿ç”¨æ¸ˆã¿æ—¥æ™‚ã€ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ åˆ¶å¾¡ç”¨ |
| IPã‚¢ãƒ‰ãƒ¬ã‚¹ | ip_address | VARCHAR(45) | YES | | ç™ºè¡Œå…ƒIPã€ä¸æ­£æ¤œçŸ¥ç”¨ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | user_agent | VARCHAR(255) | YES | | ç™ºè¡Œç’°å¢ƒæƒ…å ±ã€ç•°å¸¸æ¤œçŸ¥ç”¨ |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **PRIMARY KEY**: token_hash
- **INDEX**: email, expires_at, user_id

#### ç‰¹è¨˜äº‹é …
- ãƒˆãƒ¼ã‚¯ãƒ³ã¯15åˆ†é–“æœ‰åŠ¹ï¼ˆ`expires_at`ï¼‰
- ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ä½¿ç”¨ï¼ˆ`used_at`æ›´æ–°ã§ç„¡åŠ¹åŒ–ï¼‰
- DBã«ã¯ç”Ÿãƒˆãƒ¼ã‚¯ãƒ³ã§ã¯ãªããƒãƒƒã‚·ãƒ¥å€¤ã®ã¿ä¿å­˜

---

### 6. sessionsï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰â­â­â­

**ç”¨é€”**: ç«¯æœ«ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†ã¨åˆ¶å¾¡

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ID | session_id | VARCHAR(100) | NO (PK) | | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€æ„è­˜åˆ¥å­ã€Redisé€£æºç”¨ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | NO | | users.user_idã¨ã®ç´ä»˜ã‘ |
| ãƒ‡ãƒã‚¤ã‚¹ID | device_id | VARCHAR(100) | NO | | ç«¯æœ«è­˜åˆ¥ã€åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³åˆ¶å¾¡ç”¨ |
| IPã‚¢ãƒ‰ãƒ¬ã‚¹ | ip_address | VARCHAR(45) | YES | | ã‚¢ã‚¯ã‚»ã‚¹å…ƒIPã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ç”¨ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | user_agent | VARCHAR(255) | YES | | ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã€ç’°å¢ƒè­˜åˆ¥ç”¨ |
| ä½œæˆæ—¥æ™‚ | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ—¥æ™‚ |
| æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹ | last_seen_at | TIMESTAMP | YES | | æœ€çµ‚æ´»å‹•æ—¥æ™‚ã€éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¤œçŸ¥ |
| å¤±åŠ¹ãƒ•ãƒ©ã‚° | is_revoked | BOOLEAN | NO | FALSE | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ã€å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç”¨ |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **UNIQUE KEY**: (user_id, device_id) - å°æ•°åˆ¶é™ãƒ»é‡è¤‡é˜²æ­¢
- **INDEX**: user_id, device_id, last_seen_at

---

### 7. refresh_tokensï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ï¼‰â­â­â­

**ç”¨é€”**: JWTãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ã¨å›è»¢åˆ¶å¾¡

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ãƒˆãƒ¼ã‚¯ãƒ³ID | token_id | VARCHAR(100) | NO (PK) | | ã‚µãƒ¼ãƒãƒ¼ç”ŸæˆIDã€JTIç›¸å½“ã€ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ç”¨ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ID | session_id | VARCHAR(100) | NO | | sessions.session_idã¨ã®ç´ä»˜ã‘ |
| ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥ | token_hash | VARCHAR(255) | NO | | ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³å€¤ã€æ¤œè¨¼ç”¨ |
| ç™ºè¡Œæ—¥æ™‚ | issued_at | DATETIME | NO | | ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œæ—¥æ™‚ã€ç›£æŸ»ç”¨ |
| æœ‰åŠ¹æœŸé™ | expires_at | DATETIME | NO | | 30ã€œ90æ—¥å¾Œè¨­å®šã€é•·æœŸèªè¨¼ç”¨ |
| å›è»¢å…ƒID | rotated_from | VARCHAR(100) | YES | | æ—§ãƒˆãƒ¼ã‚¯ãƒ³IDã€ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´è¿½è·¡ |
| å¤±åŠ¹ãƒ•ãƒ©ã‚° | is_revoked | BOOLEAN | NO | FALSE | å¤±åŠ¹çŠ¶æ…‹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶å¾¡ç”¨ |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **UNIQUE KEY**: token_hash
- **INDEX**: session_id, expires_at, is_revoked

#### ç‰¹è¨˜äº‹é …
- ã€Œå›è»¢å¼ã€ãƒˆãƒ¼ã‚¯ãƒ³æ¡ç”¨ï¼ˆä½¿ç”¨æ™‚ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œï¼‰
- `rotated_from`ã§ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’è¿½è·¡å¯èƒ½

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ç›£æŸ»ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°

### 8. login_attemptsï¼ˆãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œè¨˜éŒ²ï¼‰â­â­â­

**ç”¨é€”**: ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã®è¨˜éŒ²ã¨ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| è©¦è¡ŒID | attempt_id | BIGINT AUTO_INCREMENT | NO (PK) | | è©¦è¡Œä¸€æ„è­˜åˆ¥å­ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | YES | | å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯NULLï¼‰ |
| ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ | email | VARCHAR(255) | NO | | è©¦è¡Œã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| èªè¨¼æ–¹å¼ | auth_method | ENUM | NO | | èªè¨¼æ–¹å¼ï¼ˆmagic_link/password/2faï¼‰ |
| IPã‚¢ãƒ‰ãƒ¬ã‚¹ | ip_address | VARCHAR(45) | NO | | ã‚¢ã‚¯ã‚»ã‚¹å…ƒIPã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨ |
| æˆåŠŸãƒ•ãƒ©ã‚° | success | BOOLEAN | NO | FALSE | èªè¨¼æˆåŠŸãƒ»å¤±æ•— |
| å¤±æ•—ç†ç”± | failure_reason | ENUM | YES | | å¤±æ•—ç†ç”±è©³ç´° |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | user_agent | VARCHAR(255) | YES | | ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ± |
| è©¦è¡Œæ—¥æ™‚ | attempted_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | è©¦è¡Œæ—¥æ™‚ |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **INDEX**: user_id, email, ip_address, attempted_at

---

### 9. security_eventsï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²ï¼‰â­â­â­

**ç”¨é€”**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²ã¨ç›£æŸ»

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ã‚¤ãƒ™ãƒ³ãƒˆID | event_id | BIGINT AUTO_INCREMENT | NO (PK) | | ã‚¤ãƒ™ãƒ³ãƒˆä¸€æ„è­˜åˆ¥å­ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | YES | | é–¢é€£ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã¯NULLï¼‰ |
| ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ— | event_type | ENUM | NO | | ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥è©³ç´° |
| é‡è¦åº¦ | severity | ENUM | NO | 'info' | ã‚¤ãƒ™ãƒ³ãƒˆé‡è¦åº¦ï¼ˆlow/medium/high/criticalï¼‰ |
| IPã‚¢ãƒ‰ãƒ¬ã‚¹ | ip_address | VARCHAR(45) | YES | | é–¢é€£IPã‚¢ãƒ‰ãƒ¬ã‚¹ |
| ãƒ‡ãƒã‚¤ã‚¹æƒ…å ± | device_info | JSON | YES | | ç«¯æœ«è©³ç´°æƒ…å ± |
| ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´° | event_details | JSON | YES | | è¿½åŠ æƒ…å ±ãƒ»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ |
| ä½œæˆæ—¥æ™‚ | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ—¥æ™‚ |

#### ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ä¸€è¦§
- `magic_link_issued`: Magic Linkç™ºè¡Œ
- `magic_link_used`: Magic Linkä½¿ç”¨
- `login_success`: ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
- `login_failed`: ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
- `password_set`: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
- `password_reset`: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
- `session_revoked`: ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤±åŠ¹
- `token_rotated`: ãƒˆãƒ¼ã‚¯ãƒ³ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- `2fa_enabled`: 2FAæœ‰åŠ¹åŒ–
- `2fa_disabled`: 2FAç„¡åŠ¹åŒ–
- `suspicious_activity`: ä¸å¯©ãªã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£

---

## ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°

### 10. battle_resultsï¼ˆãƒãƒˆãƒ«çµæœè¨˜éŒ²ï¼‰â­â­â­

**ç”¨é€”**: ã˜ã‚ƒã‚“ã‘ã‚“ãƒãƒˆãƒ«ã®çµæœè¨˜éŒ²ã¨çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ç®¡ç†

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| æˆ¦é—˜ç•ªå· | fight_no | BIGINT AUTO_INCREMENT | NO | | æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ äº’æ›ç”¨ã€å†…éƒ¨ç®¡ç† |
| ãƒãƒˆãƒ«ID | battle_id | VARCHAR(100) | NO (PK) | | ãƒãƒˆãƒ«ä¸€æ„è­˜åˆ¥å­ã€Redisé€£æºç”¨ |
| ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ID | player1_id | VARCHAR(50) | NO | | å‚åŠ è€…1ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ID | player2_id | VARCHAR(50) | NO | | å‚åŠ è€…2ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| å‹è€…ID | winner_id | VARCHAR(50) | YES | | å‹åˆ©è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¼•ãåˆ†ã‘ã¯NULLï¼‰ |
| ç·ãƒ©ã‚¦ãƒ³ãƒ‰æ•° | total_rounds | INT | NO | 0 | å®Ÿè¡Œã•ã‚ŒãŸãƒ©ã‚¦ãƒ³ãƒ‰æ•° |
| ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1å‹åˆ©æ•° | player1_wins | INT | NO | 0 | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®å‹åˆ©ãƒ©ã‚¦ãƒ³ãƒ‰æ•° |
| ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2å‹åˆ©æ•° | player2_wins | INT | NO | 0 | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®å‹åˆ©ãƒ©ã‚¦ãƒ³ãƒ‰æ•° |
| å¼•ãåˆ†ã‘æ•° | draws | INT | NO | 0 | å¼•ãåˆ†ã‘ãƒ©ã‚¦ãƒ³ãƒ‰æ•° |
| ãƒãƒˆãƒ«å½¢å¼ | battle_type | ENUM | NO | 'standard' | ãƒãƒˆãƒ«ç¨®åˆ¥ï¼ˆstandard/tournament/friendï¼‰ |
| é–‹å§‹æ—¥æ™‚ | started_at | TIMESTAMP | YES | | ãƒãƒˆãƒ«é–‹å§‹æ—¥æ™‚ |
| çµ‚äº†æ—¥æ™‚ | finished_at | TIMESTAMP | YES | | ãƒãƒˆãƒ«çµ‚äº†æ—¥æ™‚ |
| ä½œæˆæ—¥æ™‚ | created_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ—¥æ™‚ |

#### å¤–éƒ¨ã‚­ãƒ¼
- **player1_id** â†’ users(user_id) ON DELETE CASCADE
- **player2_id** â†’ users(user_id) ON DELETE CASCADE
- **winner_id** â†’ users(user_id) ON DELETE SET NULL

---

### 11. user_statsï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆï¼‰â­â­â­

**ç”¨é€”**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¯¾æˆ¦æˆç¸¾ã¨çµ±è¨ˆæƒ…å ±ç®¡ç†

| ã‚«ãƒ©ãƒ å | ç‰©ç†å | å‹ | NULLè¨±å¯ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ãƒ»ç”¨é€” |
|---------|--------|-----|----------|------------|------------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ID | user_id | VARCHAR(50) | NO (PK) | | users.user_idã¨ã®ç´ä»˜ã‘ |
| ç·è©¦åˆæ•° | total_matches | INT | NO | 0 | å‚åŠ ã—ãŸç·è©¦åˆæ•° |
| ç·å‹åˆ©æ•° | total_wins | INT | NO | 0 | å‹åˆ©ã—ãŸè©¦åˆæ•° |
| ç·æ•—åŒ—æ•° | total_losses | INT | NO | 0 | æ•—åŒ—ã—ãŸè©¦åˆæ•° |
| ç·å¼•ãåˆ†ã‘æ•° | total_draws | INT | NO | 0 | å¼•ãåˆ†ã‘ãŸè©¦åˆæ•° |
| å‹ç‡ | win_rate | DECIMAL(5,2) | NO | 0.00 | å‹ç‡ï¼ˆï¼…ï¼‰ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ |
| ç¾åœ¨é€£å‹æ•° | current_streak | INT | NO | 0 | ç¾åœ¨ã®é€£å‹è¨˜éŒ² |
| æœ€é«˜é€£å‹æ•° | best_streak | INT | NO | 0 | éå»æœ€é«˜ã®é€£å‹è¨˜éŒ² |
| ã‚°ãƒ¼ä½¿ç”¨å›æ•° | rock_count | INT | NO | 0 | ã‚°ãƒ¼ã‚’å‡ºã—ãŸå›æ•° |
| ãƒ‘ãƒ¼ä½¿ç”¨å›æ•° | paper_count | INT | NO | 0 | ãƒ‘ãƒ¼ã‚’å‡ºã—ãŸå›æ•° |
| ãƒãƒ§ã‚­ä½¿ç”¨å›æ•° | scissors_count | INT | NO | 0 | ãƒãƒ§ã‚­ã‚’å‡ºã—ãŸå›æ•° |
| ãŠæ°—ã«å…¥ã‚Šã®æ‰‹ | favorite_hand | ENUM | YES | | æœ€ã‚‚å¤šãä½¿ç”¨ã™ã‚‹æ‰‹ |
| ç›´è¿‘æˆ¦ç¸¾ | recent_results | VARCHAR(255) | NO | '' | ç›´è¿‘5æˆ¦ã®çµæœæ–‡å­—åˆ— |
| å½“æ—¥å‹åˆ©æ•° | daily_wins | INT | NO | 0 | å½“æ—¥ã®å‹åˆ©æ•°ï¼ˆæ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆï¼‰ |
| å½“æ—¥æ•—åŒ—æ•° | daily_losses | INT | NO | 0 | å½“æ—¥ã®æ•—åŒ—æ•°ï¼ˆæ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆï¼‰ |
| å½“æ—¥å¼•ãåˆ†ã‘æ•° | daily_draws | INT | NO | 0 | å½“æ—¥ã®å¼•ãåˆ†ã‘æ•°ï¼ˆæ—¥æ¬¡ãƒªã‚»ãƒƒãƒˆï¼‰ |
| ç§°å· | title | VARCHAR(50) | NO | '' | ç¾åœ¨ã®è¡¨ç¤ºç§°å· |
| ç²å¾—ç§°å·ä¸€è¦§ | available_titles | VARCHAR(255) | NO | '' | ç²å¾—æ¸ˆã¿ç§°å·ã®CSV |
| äºŒã¤å | alias | VARCHAR(50) | NO | '' | ç¾åœ¨ã®äºŒã¤å |
| ç§°å·è¡¨ç¤ºè¨­å®š | show_title | BOOLEAN | NO | TRUE | ç§°å·ã®å…¬é–‹è¨­å®š |
| äºŒã¤åè¡¨ç¤ºè¨­å®š | show_alias | BOOLEAN | NO | TRUE | äºŒã¤åã®å…¬é–‹è¨­å®š |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚¯ | user_rank | ENUM | NO | 'no_rank' | ãƒ©ãƒ³ã‚¯ï¼ˆno_rank/bronze/silver/gold/platinum/diamondï¼‰ |
| æœ€çµ‚ãƒªã‚»ãƒƒãƒˆæ—¥ | last_reset_at | DATE | YES | | æ—¥æ¬¡çµ±è¨ˆãƒªã‚»ãƒƒãƒˆæ—¥ |
| æœ€çµ‚å¯¾æˆ¦æ—¥æ™‚ | last_battle_at | TIMESTAMP | YES | | æœ€å¾Œã«å¯¾æˆ¦ã—ãŸæ—¥æ™‚ |
| æ›´æ–°æ—¥æ™‚ | updated_at | TIMESTAMP | NO | CURRENT_TIMESTAMP | çµ±è¨ˆæ›´æ–°æ—¥æ™‚ |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **INDEX**: win_rate DESC, total_matches DESCï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰
- **INDEX**: user_rank, daily_wins DESCï¼ˆãƒ‡ã‚¤ãƒªãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰

---

## ãƒ“ãƒ¥ãƒ¼ï¼ˆä»®æƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ä¸€è¦§

### 1. user_auth_summaryï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚µãƒãƒªãƒ¼ï¼‰
**ç”¨é€”**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼è¨­å®šçŠ¶æ³ã‚’ä¸€è¦§è¡¨ç¤º

```sql
SELECT 
    u.user_id,
    u.email,
    u.nickname,
    ac.is_password_enabled,
    tfa.enabled as two_factor_enabled,
    COUNT(s.session_id) as active_sessions,
    u.last_login_at
FROM users u
LEFT JOIN auth_credentials ac ON u.user_id = ac.user_id
LEFT JOIN two_factor_auth tfa ON u.user_id = tfa.user_id
LEFT JOIN sessions s ON u.user_id = s.user_id AND s.is_revoked = FALSE
```

### 2. today_rankingsï¼ˆä»Šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰
**ç”¨é€”**: å½“æ—¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º

```sql
SELECT 
    us.user_id,
    u.nickname,
    us.daily_wins,
    us.daily_losses + us.daily_draws as daily_total,
    CASE 
        WHEN (us.daily_wins + us.daily_losses + us.daily_draws) = 0 THEN 0
        ELSE ROUND(us.daily_wins * 100.0 / (us.daily_wins + us.daily_losses + us.daily_draws), 2)
    END as daily_win_rate
FROM user_stats us
JOIN users u ON us.user_id = u.user_id
WHERE us.daily_wins > 0
ORDER BY daily_win_rate DESC, us.daily_wins DESC
```

### 3. battle_historyï¼ˆãƒãƒˆãƒ«å±¥æ­´ï¼‰
**ç”¨é€”**: ãƒãƒˆãƒ«å±¥æ­´ã®è©³ç´°è¡¨ç¤º

```sql
SELECT 
    br.battle_id,
    p1.nickname as player1_nickname,
    p2.nickname as player2_nickname,
    COALESCE(winner.nickname, 'å¼•ãåˆ†ã‘') as result,
    br.total_rounds,
    br.started_at,
    br.finished_at
FROM battle_results br
JOIN users p1 ON br.player1_id = p1.user_id
JOIN users p2 ON br.player2_id = p2.user_id
LEFT JOIN users winner ON br.winner_id = winner.user_id
ORDER BY br.created_at DESC
```

---

## ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã®è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

| ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å | ã‚«ãƒ©ãƒ  | ç”¨é€” |
|---------|---------------|--------|------|
| sessions | idx_sessions_user_device | (user_id, device_id) | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ç«¯æœ«åˆ¥ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œç´¢ |
| refresh_tokens | idx_refresh_tokens_session_expires | (session_id, expires_at) | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»æœŸé™åˆ¥ãƒˆãƒ¼ã‚¯ãƒ³æ¤œç´¢ |
| magic_link_tokens | idx_magic_link_email_expires | (email, expires_at) | ãƒ¡ãƒ¼ãƒ«ãƒ»æœŸé™åˆ¥ãƒˆãƒ¼ã‚¯ãƒ³æ¤œç´¢ |
| security_events | idx_security_events_user_type | (user_id, event_type) | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥æ¤œç´¢ |
| battle_results | idx_battle_results_players_created | (player1_id, player2_id, created_at) | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ä½œæˆæ—¥åˆ¥ãƒãƒˆãƒ«æ¤œç´¢ |
| user_stats | idx_user_stats_win_rate_matches | (win_rate DESC, total_matches DESC) | å‹ç‡ãƒ»è©¦åˆæ•°åˆ¥çµ±è¨ˆæ¤œç´¢ |
| login_attempts | idx_login_attempts_ip_time | (ip_address, attempt_time) | IPãƒ»æ™‚åˆ»åˆ¥ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œæ¤œç´¢ |

---

## ãƒ‡ãƒ¼ã‚¿ä¿æŒãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒãƒªã‚·ãƒ¼

### å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆè‡ªå‹•åŒ–æ¨å¥¨ï¼‰

#### æ—¥æ¬¡å‡¦ç†
```sql
-- æœŸé™åˆ‡ã‚ŒMagic Linkãƒˆãƒ¼ã‚¯ãƒ³ã®å‰Šé™¤
DELETE FROM magic_link_tokens 
WHERE expires_at < DATE_SUB(NOW(), INTERVAL 1 DAY);

-- æœŸé™åˆ‡ã‚Œãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®å‰Šé™¤
DELETE FROM refresh_tokens 
WHERE expires_at < NOW() AND is_revoked = TRUE;

-- å¤ã„JWTãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚¨ãƒ³ãƒˆãƒªã®å‰Šé™¤
DELETE FROM jwt_blacklist 
WHERE expires_at < NOW();
```

#### é€±æ¬¡å‡¦ç†
```sql
-- å¤ã„ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œè¨˜éŒ²ã®å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šï¼‰
DELETE FROM login_attempts 
WHERE attempted_at < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å‰Šé™¤ï¼ˆ7æ—¥ä»¥ä¸Šã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰
DELETE FROM sessions 
WHERE last_seen_at < DATE_SUB(NOW(), INTERVAL 7 DAY);
```

#### æœˆæ¬¡å‡¦ç†
```sql
-- å¤ã„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®å‰Šé™¤ï¼ˆ6ãƒ¶æœˆä»¥ä¸Šï¼‰
DELETE FROM security_events 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- å¤ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ã®å‰Šé™¤ï¼ˆ3ãƒ¶æœˆä»¥ä¸Šï¼‰
DELETE FROM activity_logs 
WHERE created_at < DATE_SUB(NOW(), INTERVAL 3 MONTH);
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶
- **æœ€å°é•·**: 8æ–‡å­—ä»¥ä¸Š
- **æ–‡å­—ç¨®**: è‹±æ•°å­— + ç‰¹æ®Šæ–‡å­—æ¨å¥¨
- **ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: Argon2idï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- **ã‚½ãƒ«ãƒˆ**: è‡ªå‹•ç”Ÿæˆï¼ˆArgon2idã«å†…åŒ…ï¼‰

### ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨­å®š
| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | åˆ¶é™ | çª“æ™‚é–“ |
|---------------|------|--------|
| Magic Linkè¦æ±‚ | 5å› | 5åˆ†é–“ |
| ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ | 10å› | 15åˆ†é–“ |
| ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ | 3å› | 30åˆ†é–“ |
| 2FAæ¤œè¨¼ | 5å› | 10åˆ†é–“ |

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™**: 15åˆ†
- **ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™**: 30æ—¥
- **åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³ç«¯æœ«æ•°**: 5å°ã¾ã§ï¼ˆè¨­å®šå¯èƒ½ï¼‰
- **éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 7æ—¥

---

## Redisé€£æºè¨­è¨ˆ

### Redisã§ç®¡ç†ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£
```redis
# ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆTTL: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨åŒæœŸï¼‰
SET session:{session_id} '{"user_id":"user_123","device_id":"device_abc","last_seen":"2024-01-01T12:00:00Z"}' EX 900

# WebSocketæ¥ç¶šçŠ¶æ…‹
SET websocket:user:{user_id} '{"session_id":"session_123","socket_id":"socket_789"}' EX 3600
```

#### ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```redis
# Magic Linké€ä¿¡åˆ¶é™
SET ratelimit:magiclink:{email} 1 EX 300

# ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œåˆ¶é™
INCR ratelimit:login:{ip_address} EX 900
```

#### ã‚²ãƒ¼ãƒ é–¢é€£
```redis
# ãƒãƒƒãƒãƒ³ã‚°ã‚­ãƒ¥ãƒ¼
LPUSH matching_queue "{user_id}"

# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒˆãƒ«çŠ¶æ…‹
HSET battle:{battle_id} "status" "active" "round" "2"
```

---

## æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®äº’æ›æ€§

### ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°

| æ—§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | æ–°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å¤‰æ›æ–¹æ³• |
|-------------|-------------|----------|
| users.management_code | users.management_code | ç›´æ¥ãƒãƒƒãƒ”ãƒ³ã‚° |
| users.password | auth_credentials.password_hash | ãƒãƒƒã‚·ãƒ¥å¤‰æ›ãŒå¿…è¦ |
| users.profile_image_url | user_profiles.profile_image_url | ç›´æ¥ãƒãƒƒãƒ”ãƒ³ã‚° |
| users.student_id_image_url | user_profiles.student_id_image_url | ç›´æ¥ãƒãƒƒãƒ”ãƒ³ã‚° |
| match_history.fight_no | battle_results.fight_no | ç›´æ¥ãƒãƒƒãƒ”ãƒ³ã‚° |

### ç§»è¡Œæ™‚ã®æ³¨æ„ç‚¹
1. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å†ãƒãƒƒã‚·ãƒ¥åŒ–**: æ—¢å­˜ã®ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‹ã‚‰Argon2idã¸ã®ç§»è¡Œ
2. **ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURL**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã®è¨­å®šã¨NOT NULLåˆ¶ç´„ã¸ã®å¯¾å¿œ
3. **çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§**: user_statsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®æ•´åˆæ€§ç¢ºä¿

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

#### 1. Magic LinkãŒå±Šã‹ãªã„
- `magic_link_tokens`ãƒ†ãƒ¼ãƒ–ãƒ«ã§ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã‚’ç¢ºèª
- `security_events`ãƒ†ãƒ¼ãƒ–ãƒ«ã§é€ä¿¡ãƒ­ã‚°ã‚’ç¢ºèª
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆRedisï¼‰ã®çŠ¶æ³ç¢ºèª

#### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã«ãªã‚‹
- `sessions`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`is_revoked`ãƒ•ãƒ©ã‚°ç¢ºèª
- `refresh_tokens`ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ‰åŠ¹æœŸé™ç¢ºèª
- Rediså†…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ³ç¢ºèª

#### 3. ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„
- `login_attempts`ãƒ†ãƒ¼ãƒ–ãƒ«ã§è©¦è¡Œå±¥æ­´ç¢ºèª
- `security_events`ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ç¢ºèª
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ï¼ˆ`users.is_active`ï¼‰ç¢ºèª

### ç›£è¦–ã™ã¹ããƒ¡ãƒˆãƒªã‚¯ã‚¹
- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°**: `SELECT COUNT(*) FROM sessions WHERE is_revoked = FALSE`
- **Magic Linkä½¿ç”¨ç‡**: security_eventsã®æˆåŠŸç‡
- **ç•°å¸¸ãƒ­ã‚°ã‚¤ãƒ³**: è¤‡æ•°åœ°ç‚¹ã‹ã‚‰ã®çŸ­æ™‚é–“ã‚¢ã‚¯ã‚»ã‚¹
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç™ºå‹•å›æ•°**: Rediså†…ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚«ã‚¦ãƒ³ã‚¿

---

**ä½œæˆæ—¥**: 2024å¹´12æœˆ  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**å¯¾å¿œã‚·ã‚¹ãƒ†ãƒ **: Magic Link + JWT + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰èªè¨¼ã‚·ã‚¹ãƒ†ãƒ   
**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: MySQL 8.0+  
**æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**: utf8mb4_unicode_ci
