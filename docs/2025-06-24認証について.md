# 認証仕様書

## 1. ユーザー認証仕様（Magic Link方式）

### 🔐 基本方針
| 項目     | 内容                                              |
| ------ | ----------------------------------------------- |
| ユーザー識別 | メールアドレス（唯一のID）を使用。ユーザーIDやパスワードは不要。              |
| ログイン方式 | Magic Link（メールに届いたURL）を用いたワンタイムログイン             |
| トークン管理 | ログイン後はJWTをクライアントに保存し、次回以降の認証に利用                 |
| アプリ起動  | メール内リンクはWebページを中継し、ユーザーが手動でアプリを起動してログイン処理を完了させる |
| 開発支援   | 開発環境とVPS環境では、簡易ログインボタンでJWTを即時発行可能               |

### 🧭 認証フロー概要（スマホ前提）

1. ユーザーがメールアドレスを入力
2. 「じゃんけんに勝つ手は？」CAPTCHAでbot対策
3. reCAPTCHA v2（checkbox）も併用し、Bot判定
4. すべて正解すればMagic Linkをメール送信（SES）
5. ユーザーがメールを開き、リンクをタップ
6. S3ホスティングのWebページが開き「リンク確認済みです。アプリを起動してください」と案内
7. アプリを起動すると、保存済みの `email` と `token` を使って `verify` API を呼び出し
8. JWTが発行され、アプリ内で認証完了

### 📮 メールリンク仕様

* 形式：
  `https://app.example.com/magic-login?token=abc123xyz`
* 有効期限：**15分**
* 使用制限：**ワンタイム（1回限り）使用可能**
* トークン照合後、DBから削除 or `used=true` フラグ付与

### 🔐 bot対策仕様（全採用項目）

| 対策                          | 内容                                                              |
| --------------------------- | --------------------------------------------------------------- |
| ✅ じゃんけんCAPTCHA              | 「相手がチョキを出しています。勝つ手を選んでください」など3択出題。毎回ランダム出題。                     |
| ✅ reCAPTCHA v2              | Google提供のBot判定。`POST /auth/request-link`の前にフロント側で取得し、APIに含めて送信。 |
| ✅ CAPTCHA署名トークン             | 出題時にトークンを生成し、回答と一緒に送信して改ざん防止。                                   |
| ✅ IP単位のRate Limiting（オプション） | 短時間で複数回リクエストが来た場合はリジェクト。例：5分間に5回まで。                             |

### 🗄️ API構成（簡略）

#### 🔹 `POST /auth/request-link`

| 入力                 | 内容                           |
| ------------------ | ---------------------------- |
| `email`            | ユーザーのメールアドレス                 |
| `captcha.opponent` | 出題された手（例："✌️"）               |
| `captcha.answer`   | ユーザーの選択した手（例："✊"）            |
| `captcha.token`    | CAPTCHA出題時に発行された署名付きトークン     |
| `recaptchaToken`   | Google reCAPTCHA v2で取得したトークン |

\| 出力 |

```json
{ "message": "Magic link sent." }
```

#### 🔹 `GET /auth/verify?token=abc123xyz`

* 入力：メールリンクに含まれた `token`
* 処理：DynamoDBで該当トークンを検索 → 有効ならJWTを返却
* 出力例：

```json
{
  "token": "JWTトークン文字列",
  "user": {
    "email": "user@example.com"
  }
}
```

### 🧠 DB構成：ユーザー＆トークン管理

#### `users` テーブル（DynamoDB）

| フィールド         | 内容                             |
| ------------- | ------------------------------ |
| `email`       | 一意なユーザー識別子                     |
| `createdAt`   | 初回登録日時                         |
| `lastLoginAt` | 最終ログイン日時                       |
| `status`      | `"active"` or `"suspended"` など |
| `metadata`    | 任意：アバター、勝利数など                  |

#### `magic_links` テーブル

| フィールド       | 内容                |
| ----------- | ----------------- |
| `token`     | UUID形式のログイン用トークン  |
| `email`     | 発行先ユーザーのメールアドレス   |
| `createdAt` | 発行日時              |
| `expiresAt` | 有効期限（例：10分後）      |
| `used`      | 使用済みかどうか（boolean） |

### 🔐 JWT仕様（セッション維持）

* JWTの発行は `verify` 成功後
* 内容例：

```json
{
  "email": "user@example.com",
  "iat": 1718820000,
  "exp": 1719424800 // 7日間有効など
}
```

* 保存先：アプリ内のSecureStorageまたはAsyncStorage等

### 🎨 UI仕様（CAPTCHA出題）

* 出題は3択からランダム表示

* 表示例：

  ```
  相手は ✋ を出しています。
  勝つためにはどれを出せばいいでしょう？
  [✊ グー] [✌️ チョキ] [✋ パー]
  ```

* 出題とともに `captchaToken` を発行し、APIで検証時に利用

## ✅ この構成のメリット

| 面      | 特徴                                                |
| ------ | ------------------------------------------------- |
| セキュリティ | 多層的な認証（ユーザー認証＋API認証）で堅牢なセキュリティを実現           |
| UX     | ユーザーはメールアドレスだけでログイン。バックグラウンドでAPI認証を自動処理    |
| 拡張性    | 環境ごとに認証レベルを調整可能。新しい認証方式の追加も容易              |
| 運用     | 開発効率と本番環境のセキュリティを両立。環境別の監視・ログ体制を確立        |

## 📝 仕様書用の1文サマリー

> 本システムでは、エンドユーザーの認証にMagic Link方式を採用し、APIアクセスには環境に応じた多層的な認証（Bearer Token + APIキー）を実装する。開発環境では認証をスキップ可能とし、VPS環境ではBearer Token認証を必須とし、AWS環境ではさらにAPIキー認証を追加することで、開発効率とセキュリティを段階的に強化する構成とする。

## 2. API認証仕様（3層構造）

### 🔐 環境別認証方式

すべての環境で基本的な認証フローは同一とし、開発効率とセキュリティのバランスを取ります：

1. **共通仕様**
   - Bearer Token認証（JWT）を基本とする
   - トークン有効期限: 24時間
   - リフレッシュトークン: 30日
   - レート制限: 環境ごとに設定可能

2. **環境別の特徴**
   - **開発環境**
     - 簡易ログインボタンでJWT即時発行可能
     - reCAPTCHAはオプション（環境変数で制御）
     - デバッグ用ヘッダー許可
     - レート制限: なし

   - **VPS環境**
     - 簡易ログインボタンでJWT即時発行可能
     - reCAPTCHA必須
     - レート制限: 1000req/min

   - **AWS環境**
     - 通常の認証フローのみ（簡易ログイン不可）
     - reCAPTCHA必須
     - APIキー認証追加
     - レート制限: 2000req/min

### 🔑 API認証ヘッダー仕様
```http
# 必須ヘッダー
Content-Type: application/json; charset=utf-8
Accept: application/json
Accept-Charset: utf-8

# 認証ヘッダー（環境に応じて必須）
Authorization: Bearer {jwt_token}    # VPS・AWS環境で必須
x-api-key: {api_key}                # AWS環境でのみ必須

# トレーシングヘッダー
x-request-id: {UUID}                # リクエスト追跡用
x-environment: {環境名}             # 環境識別用
x-api-version: {API_VERSION}        # APIバージョン
x-client-version: {CLIENT_VERSION}  # クライアントバージョン
```

### 📝 認証の関係性

1. **ユーザー認証とAPI認証の関係**
   - ユーザー認証：エンドユーザーの本人確認（Magic Link）
   - API認証：APIエンドポイントへのアクセス制御（Bearer Token + APIキー）

2. **トークンの使い分け**
   - Magic Linkトークン：ユーザーログイン時の一時的なトークン
   - JWTトークン：API認証用の継続的なアクセストークン
   - APIキー：AWS環境でのシステムレベルの認証

3. **セキュリティレイヤー**
   ```mermaid
   graph TD
     A[クライアントアプリ] -->|1. Magic Link認証| B[ユーザー認証層]
     B -->|2. JWT発行| C[API認証層]
     C -->|3. APIキー認証| D[AWS API Gateway]
     D -->|4. Bearer認証| E[アプリケーション層]
   ```

### 🔒 セキュリティ監査・ログ
- アクセスログの保持期間
  - 開発環境: 7日間
  - VPS環境: 30日間
  - AWS環境: 90日間
- セキュリティ監査の実施
  - 開発環境: 必要に応じて
  - VPS環境: 週次
  - AWS環境: 日次

### 🧱 開発用簡易ログイン機能

#### 🔹 `POST /auth/dev-login`

開発環境とVPS環境でのみ利用可能な簡易ログインエンドポイント：

| 入力      | 内容                    |
| ------- | --------------------- |
| `email` | 開発用アカウントのメールアドレス      |
| `mode`  | `"dev"` または `"admin"` |

出力例：
```json
{
  "token": "JWTトークン文字列",
  "user": {
    "email": "dev@example.com",
    "role": "developer"
  }
}
```

#### 🎨 UI実装例

開発環境では、ログイン画面に以下のようなボタンを追加：

```
[開発用アカウントでログイン]
[管理者アカウントでログイン]
```

VPS環境では管理者アカウントでログイン後に開発者向けメニューで表示：

```
[開発者メニュー]
└── [開発用JWTの発行]
```

### ⚠️ 実装時の注意事項

1. **環境判定とセキュリティ**
   - 環境変数 `NODE_ENV` による厳密な環境判定
   - 本番環境での開発用エンドポイントの完全無効化
   - VPSでの管理者権限の適切な検証

2. **開発用アカウント管理**
   - 開発用アカウントは環境変数で設定
   - VPS環境では管理者のみが発行可能
   - 開発用JWTの有効期限を通常より短く設定

3. **ログと監視**
   - 開発用ログイン試行の詳細なログ記録
   - 不正アクセスの検知と通知
   - 定期的なアクセスログの監査

