// Ë™çË®ºAPI „ÉÜ„Çπ„ÉàÁî® JavaScript

let currentJWT = null;
let captchaChallenge = {
    opponent: '‚úåÔ∏è',
    token: generateCaptchaToken()
};

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    console.log('Auth test page loaded');
    console.log('Available functions:', {
        simpleApiTest: typeof simpleApiTest,
        simpleDevLogin: typeof simpleDevLogin
    });
    
    // URL„Éë„É©„É°„Éº„Çø„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('login_success') === 'true') {
        showLoginSuccessMessage();
    }
    
    // „Ç´„Çπ„Çø„É†URLË°®Á§∫Âà∂Âæ°
    document.getElementById('apiBaseUrl').addEventListener('change', function() {
        const customGroup = document.getElementById('customUrlGroup');
        if (this.value === 'custom') {
            customGroup.style.display = 'block';
        } else {
            customGroup.style.display = 'none';
        }
    });

    // ÂàùÊúüCAPTCHAÁîüÊàê
    generateCaptcha();
    
    // ‰øùÂ≠ò„Åï„Çå„ÅüJWT„Åå„ÅÇ„Çå„Å∞Âæ©ÂÖÉ
    const savedJWT = localStorage.getItem('jwt_token');
    if (savedJWT) {
        currentJWT = savedJWT;
        document.getElementById('jwtToken').value = savedJWT;
    }
});

// „É≠„Ç∞„Ç§„É≥ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
function showLoginSuccessMessage() {
    const magicLinkUser = localStorage.getItem('magic_link_user');
    if (magicLinkUser) {
        const user = JSON.parse(magicLinkUser);
        alert(`üéâ Magic LinkË™çË®º„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\n„É¶„Éº„Ç∂„Éº: ${user.email}\nJWT„Éà„Éº„ÇØ„É≥„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ`);
        
        // URL„Éë„É©„É°„Éº„Çø„Çí„ÇØ„É™„Ç¢
        const url = new URL(window.location);
        url.searchParams.delete('login_success');
        window.history.replaceState({}, document.title, url);
    }
}

// „Éô„Éº„ÇπURLÂèñÂæó
function getBaseUrl() {
    const selector = document.getElementById('apiBaseUrl');
    if (selector.value === 'custom') {
        return document.getElementById('customUrl').value;
    }
    return selector.value;
}

// Êé•Á∂ö„ÉÜ„Çπ„Éà
async function testConnection() {
    const baseUrl = getBaseUrl();
    const statusIndicator = document.getElementById('connectionStatus');
    const statusText = document.getElementById('connectionText');
    
    try {
        statusIndicator.className = 'status-indicator status-warning';
        statusText.textContent = 'Êé•Á∂ö‰∏≠...';
        
        const response = await fetch(`${baseUrl}/api/health`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            statusIndicator.className = 'status-indicator status-success';
            statusText.textContent = 'Êé•Á∂öÊàêÂäü';
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        statusIndicator.className = 'status-indicator status-error';
        statusText.textContent = `Êé•Á∂öÂ§±Êïó: ${error.message}`;
    }
}

// CAPTCHAÁîüÊàê
function generateCaptcha() {
    const hands = ['‚úä', '‚úåÔ∏è', '‚úã'];
    const opponent = hands[Math.floor(Math.random() * hands.length)];
    captchaChallenge.opponent = opponent;
    captchaChallenge.token = generateCaptchaToken();
    
    document.getElementById('opponentHand').textContent = opponent;
    
    // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
    document.querySelectorAll('.hand-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    document.getElementById('selectedHand').value = '';
}

// Êâã„ÇíÈÅ∏Êäû
function selectHand(hand) {
    document.querySelectorAll('.hand-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    const selectedBtn = document.querySelector(`[data-hand="${hand}"]`);
    selectedBtn.classList.add('selected');
    document.getElementById('selectedHand').value = hand;
}

// CAPTCHA„Éà„Éº„ÇØ„É≥ÁîüÊàêÔºàÁ∞°ÊòìÁâàÔºâ
function generateCaptchaToken() {
    return 'captcha_' + Math.random().toString(36).substring(2, 15);
}

// „É¨„Çπ„Éù„É≥„ÇπË°®Á§∫Èñ¢Êï∞
function displayResponse(elementId, response, error = null) {
    const element = document.getElementById(elementId);
    if (error) {
        element.textContent = `„Ç®„É©„Éº: ${error.message}\n\nResponse: ${JSON.stringify(response, null, 2)}`;
        element.style.backgroundColor = '#2d1b1b';
        element.style.color = '#ff9999';
    } else {
        element.textContent = JSON.stringify(response, null, 2);
        element.style.backgroundColor = '#1e1e1e';
        element.style.color = '#f8f8f2';
        
        // JWT„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ‰øùÂ≠ò
        if (response.data && response.data.token) {
            currentJWT = response.data.token;
            document.getElementById('jwtToken').value = currentJWT;
            localStorage.setItem('jwt_token', currentJWT);
        }
    }
}

// Magic Link „É™„ÇØ„Ç®„Çπ„Éà
async function requestMagicLink() {
    const baseUrl = getBaseUrl();
    const email = document.getElementById('magicEmail').value;
    const selectedHand = document.getElementById('selectedHand').value;
    const recaptchaToken = document.getElementById('recaptchaToken').value;
    
    if (!selectedHand) {
        alert('CAPTCHA„ÅÆÊâã„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const requestData = {
        email: email,
        captcha: {
            opponent: captchaChallenge.opponent,
            answer: selectedHand,
            token: captchaChallenge.token
        }
    };
    
    // reCAPTCHA„Éà„Éº„ÇØ„É≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËøΩÂä†
    if (recaptchaToken) {
        requestData.recaptcha_token = recaptchaToken;
    }
    
    try {
        const response = await fetch(`${baseUrl}/api/auth/request-link`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        displayResponse('magicLinkResponse', data);
        
        // Magic Link URL„ÇíÁîüÊàê„ÉªË°®Á§∫
        if (data.success && data.data && data.data.token) {
            showMagicLinkUrl(data.data.token);
        }
        
        // CAPTCHAÊõ¥Êñ∞
        generateCaptcha();
        
    } catch (error) {
        displayResponse('magicLinkResponse', null, error);
    }
}

// Magic Link URLË°®Á§∫
function showMagicLinkUrl(token) {
    const baseUrl = getBaseUrl();
    const magicLinkUrl = `${baseUrl}/monitoring/auth/magic-link-verify.html?token=${token}`;
    
    document.getElementById('magicLinkUrl').textContent = magicLinkUrl;
    document.getElementById('magicLinkUrlSection').style.display = 'block';
    
    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠ò
    window.currentMagicLinkUrl = magicLinkUrl;
    window.currentMagicToken = token;
}

// Magic Link„ÇíÈñã„ÅèÔºà„É°„Éº„É´‰ª£ÊõøÔºâ
function openMagicLink() {
    if (window.currentMagicLinkUrl) {
        window.open(window.currentMagicLinkUrl, '_blank');
    } else {
        alert('Magic Link URL„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÖà„Å´Magic Link„Çí„É™„ÇØ„Ç®„Çπ„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
}

// Magic Link URL„Çí„Ç≥„Éî„Éº
function copyMagicLink() {
    if (window.currentMagicLinkUrl) {
        navigator.clipboard.writeText(window.currentMagicLinkUrl).then(() => {
            alert('Magic Link URL„Åå„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åó„Åü');
        });
    } else {
        alert('„Ç≥„Éî„Éº„Åô„ÇãMagic Link URL„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
    }
}

// Magic Link Ê§úË®º
async function verifyMagicLink() {
    const baseUrl = getBaseUrl();
    const token = document.getElementById('magicToken').value;
    
    if (!token) {
        alert('Magic Link „Éà„Éº„ÇØ„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    try {
        const response = await fetch(`${baseUrl}/api/auth/verify-magic-link`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        displayResponse('verifyResponse', data);
        
    } catch (error) {
        displayResponse('verifyResponse', null, error);
    }
}

// „ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„Éº„É≠„Ç∞„Ç§„É≥
async function testUserLogin() {
    const baseUrl = getBaseUrl();
    const userNumber = parseInt(document.getElementById('testUserNumber').value);
    
    try {
        const response = await fetch(`${baseUrl}/api/auth/test-login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_number: userNumber })
        });
        
        const data = await response.json();
        displayResponse('testUserResponse', data);
        
    } catch (error) {
        displayResponse('testUserResponse', null, error);
    }
}

// ÈñãÁô∫Áî®„É≠„Ç∞„Ç§„É≥
async function devLogin() {
    const baseUrl = getBaseUrl();
    const email = document.getElementById('devEmail').value;
    const mode = document.getElementById('devMode').value;
    
    try {
        const response = await fetch(`${baseUrl}/api/auth/dev-login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: email,
                mode: mode
            })
        });
        
        const data = await response.json();
        displayResponse('devLoginResponse', data);
        
    } catch (error) {
        displayResponse('devLoginResponse', null, error);
    }
}

// ÂæìÊù•ÂΩ¢Âºè„É≠„Ç∞„Ç§„É≥
async function userInfoLogin() {
    const baseUrl = getBaseUrl();
    const userId = document.getElementById('userId').value;
    const password = document.getElementById('password').value;
    
    try {
        const response = await fetch(`${baseUrl}/api/auth/UserInfo`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: userId,
                password: password
            })
        });
        
        const data = await response.json();
        displayResponse('userInfoResponse', data);
        
    } catch (error) {
        displayResponse('userInfoResponse', null, error);
    }
}

// JWT„Éà„Éº„ÇØ„É≥„Ç≥„Éî„Éº
function copyToken() {
    const token = document.getElementById('jwtToken').value;
    if (token) {
        navigator.clipboard.writeText(token).then(() => {
            alert('„Éà„Éº„ÇØ„É≥„Åå„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åó„Åü');
        });
    } else {
        alert('„Ç≥„Éî„Éº„Åô„Çã„Éà„Éº„ÇØ„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
    }
}

// JWT„Éà„Éº„ÇØ„É≥„ÇØ„É™„Ç¢
function clearToken() {
    currentJWT = null;
    document.getElementById('jwtToken').value = '';
    localStorage.removeItem('jwt_token');
    alert('„Éà„Éº„ÇØ„É≥„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åó„Åü');
}

// JWT„Éà„Éº„ÇØ„É≥Ê§úË®º
async function validateToken() {
    const baseUrl = getBaseUrl();
    const token = document.getElementById('jwtToken').value;
    
    if (!token) {
        alert('Ê§úË®º„Åô„Çã„Éà„Éº„ÇØ„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
    }
    
    try {
        // ‰øùË≠∑„Åï„Çå„Åü„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Éà„Éº„ÇØ„É≥„ÇíÊ§úË®º
        const response = await fetch(`${baseUrl}/api/protected-test`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        displayResponse('tokenValidationResponse', data);
        
    } catch (error) {
        displayResponse('tokenValidationResponse', null, error);
    }
}

// API„ÉÜ„Çπ„ÉàÁî®„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
async function makeAuthenticatedRequest(endpoint, method = 'GET', body = null) {
    const baseUrl = getBaseUrl();
    const token = document.getElementById('jwtToken').value;
    
    const headers = {
        'Content-Type': 'application/json'
    };
    
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }
    
    const options = {
        method: method,
        headers: headers
    };
    
    if (body) {
        options.body = JSON.stringify(body);
    }
    
    try {
        const response = await fetch(`${baseUrl}${endpoint}`, options);
        return await response.json();
    } catch (error) {
        throw error;
    }
}

// „Ç∑„É≥„Éó„É´API„ÉÜ„Çπ„Éà
async function simpleApiTest() {
    const baseUrl = getBaseUrl();
    const statusIndicator = document.getElementById('connectionStatus');
    const statusText = document.getElementById('connectionText');
    
    try {
        statusIndicator.className = 'status-indicator status-warning';
        statusText.textContent = 'API„ÉÜ„Çπ„Éà‰∏≠...';
        
        const response = await fetch(`${baseUrl}/api/auth/simple-test`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            statusIndicator.className = 'status-indicator status-success';
            statusText.textContent = 'API„ÉÜ„Çπ„ÉàÊàêÂäü';
            alert(`API„ÉÜ„Çπ„ÉàÊàêÂäü: ${data.message}`);
        } else {
            throw new Error(`API Error: ${JSON.stringify(data)}`);
        }
    } catch (error) {
        statusIndicator.className = 'status-indicator status-error';
        statusText.textContent = `API„ÉÜ„Çπ„ÉàÂ§±Êïó: ${error.message}`;
        alert(`API„ÉÜ„Çπ„ÉàÂ§±Êïó: ${error.message}`);
    }
}

// „Ç∑„É≥„Éó„É´ÈñãÁô∫„É≠„Ç∞„Ç§„É≥
async function simpleDevLogin() {
    const baseUrl = getBaseUrl();
    
    try {
        const response = await fetch(`${baseUrl}/api/auth/simple-dev-login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: 'dev@example.com'
            })
        });
        
        const data = await response.json();
        displayResponse('devLoginResponse', data);
        
        if (data.success && data.data && data.data.token) {
            alert('„Ç∑„É≥„Éó„É´ÈñãÁô∫„É≠„Ç∞„Ç§„É≥ÊàêÂäüÔºÅJWT„ÅåÁô∫Ë°å„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
        }
        
    } catch (error) {
        displayResponse('devLoginResponse', null, error);
        alert(`„Ç∑„É≥„Éó„É´ÈñãÁô∫„É≠„Ç∞„Ç§„É≥Â§±Êïó: ${error.message}`);
    }
}

// „Éá„Éê„ÉÉ„Ç∞Áî®„ÅÆ„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
window.debugAuth = {
    getCurrentJWT: () => currentJWT,
    getCaptchaChallenge: () => captchaChallenge,
    testAPI: async (endpoint, method, body) => {
        return await makeAuthenticatedRequest(endpoint, method, body);
    },
    simpleTest: simpleApiTest,
    simpleLogin: simpleDevLogin
}; 